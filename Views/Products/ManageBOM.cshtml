@model WebAppERP.Models.Product
@{
    ViewData["Title"] = "Quản lý Định mức Nguyên vật liệu (BOM)";
    // Ép kiểu an toàn hơn
    var componentsInBOM = ViewBag.ComponentsInBOM as List<BillOfMaterial> ?? new List<BillOfMaterial>();
}

<h1 class="display-6">@ViewData["Title"]</h1>
<h3 class="text-muted">Thành phẩm: <span class="fw-bold">@Model.Name</span></h3>
<hr />

@* --- FORM THÊM MỚI ĐƯỢC BỐ CỤC LẠI --- *@
<div class="card card-body mb-4">
    <h5 class="card-title">Thêm Nguyên phụ liệu vào Định mức</h5>
    <form asp-action="AddComponentToBOM" method="post" class="row gx-3 gy-2 align-items-end">
        <input type="hidden" name="finishedProductId" value="@Model.Id" />

        <div class="row">
            <div class="col-md-3">
                <label class="form-label">Nguyên phụ liệu</label>
                <select name="componentId" class="form-select" asp-items="ViewBag.AvailableComponents"></select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Công đoạn</label>
                <select name="productionStageId" class="form-select" asp-items="ViewBag.ProductionStages"></select>
            </div>

            <div class="col-md-3">
                <label class="form-label">Số mảnh / SP</label>
                <input type="number" name="piecesPerProduct" id="piecesPerProduct" class="form-control bom-calc-input" />
            </div>
            <div class="col-md-3">
                <label class="form-label">GSM (g/m²)</label>
                <input type="number" step="0.1" name="gsm" id="gsm" class="form-control bom-calc-input" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Dài mảnh (m)</label>
                <input type="number" step="0.01" name="pieceLength" id="pieceLength" class="form-control bom-calc-input" />
            </div>
            <div class="col-md-3">
                <label class="form-label">Rộng mảnh (m)</label>
                <input type="number" step="0.01" name="pieceWidth" id="pieceWidth" class="form-control bom-calc-input" />
            </div>

            <div class="col-md-6">
                <label class="form-label fw-bold">Định mức sử dụng (Kết quả)</label>
                <input type="number" step="0.0001" name="quantity" id="quantity" class="form-control" required />
            </div>
        </div>

        <div class="col-md-3">
            <button type="submit" class="btn btn-primary w-100">
                <i class="bi bi-plus-circle"></i> Thêm
            </button>
        </div>
    </form>
</div>


@* --- BẢNG HIỂN THỊ ĐƯỢC CẬP NHẬT --- *@
<h4>Danh sách Nguyên phụ liệu trong Định mức</h4>
@if (!componentsInBOM.Any())
{
    <div class="alert alert-info" role="alert">
        Chưa có nguyên phụ liệu nào trong định mức này.
    </div>
}
else
{
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th>Mã NVL</th>
                <th>Tên Nguyên phụ liệu</th>
                <th>Công đoạn</th> @* << THÊM CỘT MỚI *@
                <th class="text-end">Định mức</th>
                <th style="width: 100px;"></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in componentsInBOM.OrderBy(c => c.ProductionStage.Sequence))
            {
                <tr>
                    <td>@item.Component.Sku</td>
                    <td>@item.Component.Name</td>
                    <td><span class="badge bg-secondary">@item.ProductionStage.Name</span></td> @* << HIỂN THỊ CÔNG ĐOẠN *@
                    <td class="text-end">@item.Quantity.ToString("N3") @item.Component.UnitOfMeasure</td>
                    <td class="text-end">
                        <form asp-action="DeleteComponentFromBOM" method="post">
                            <input type="hidden" name="bomId" value="@item.Id" />
                            <input type="hidden" name="finishedProductId" value="@Model.Id" />
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Bạn có chắc chắn muốn xóa?')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}


<div class="mt-4">
    <a asp-controller="Products" asp-action="Index" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Quay lại danh sách
    </a>
</div>
@section Scripts {
    <script>
        $(function () {
            // Lắng nghe sự kiện thay đổi trên các ô nhập liệu dùng để tính toán
            $('.bom-calc-input').on('input', function () {
                calculateBomQuantity();
            });

            function calculateBomQuantity() {
                const pieces = parseFloat($('#piecesPerProduct').val());
                const gsm = parseFloat($('#gsm').val());
                const length = parseFloat($('#pieceLength').val());
                const width = parseFloat($('#pieceWidth').val());

                // Nếu có đủ 4 giá trị thì mới tính
                if (!isNaN(pieces) && !isNaN(gsm) && !isNaN(length) && !isNaN(width)) {
                    // Công thức: (Dài * Rộng * Số mảnh * GSM) / 1000 = Số kg cần dùng
                    const result = (length * width * pieces * gsm) / 1000;

                    // Cập nhật giá trị vào ô kết quả và khóa nó lại
                    $('#quantity').val(result.toFixed(4)).prop('readonly', true);
                } else {
                    // Nếu không đủ, cho phép người dùng nhập tay
                    $('#quantity').prop('readonly', false);
                }
            }
        });
    </script>
}