@model List<WebAppERP.ViewModels.MaterialRequirementViewModel>

@{
    ViewData["Title"] = "Hoạch định Nhu cầu Nguyên vật liệu (MRP)";
}

<h1>@ViewData["Title"]</h1>
<p>Báo cáo này tính toán tổng nhu cầu NVL từ các Lệnh sản xuất đang hoạt động, so sánh với tồn kho và lượng đang mua để đề xuất mua hàng.</p>
<hr />

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["WarningMessage"] != null)
{
    <div class="alert alert-warning">@TempData["WarningMessage"]</div>
}

<form asp-action="CreatePurchaseOrderFromMRP" method="post">
    <div class="table-responsive">
        <table class="table table-bordered table-sm">
            <thead class="thead-light text-center">
                <tr>
                    @* SỬA LỖI GIAO DIỆN: Đặt checkbox vào cột rộng hơn một chút *@
                    <th style="width: 5%;"><input type="checkbox" id="selectAll" class="form-check-input" /></th>
                    <th>Tên Nguyên vật liệu</th>
                    <th>Tổng Nhu cầu</th>
                    <th>Tồn kho</th>
                    <th>Đang mua</th>
                    <th>Thiếu hụt</th>
                    <th>Đề xuất Mua</th>
                </tr>
            </thead>
            <tbody>
                @for (int i = 0; i < Model.Count; i++)
                {
                    var shortageClass = Model[i].ShortageQuantity > 0 ? "table-danger" : "";
                    <tr class="@shortageClass">
                        @* SỬA LỖI GIAO DIỆN: Gộp checkbox và các input ẩn vào cùng một cột *@
                        <td class="text-center">
                            <input type="hidden" asp-for="@Model[i].ProductId" />
                            <input type="hidden" asp-for="@Model[i].SuggestedPurchaseQuantity" />
                            @if (Model[i].SuggestedPurchaseQuantity > 0)
                            {
                                <input type="checkbox" asp-for="@Model[i].IsSelected" class="form-check-input" />
                            }
                        </td>
                        <td>
                            <strong>@Model[i].ProductName</strong>
                            <small class="d-block text-muted">@Model[i].ProductSku</small>
                        </td>
                        <td class="text-end">@Model[i].TotalRequiredQuantity.ToString("N2")</td>
                        <td class="text-end">@Model[i].CurrentStockQuantity.ToString("N2")</td>
                        <td class="text-end">@Model[i].OnOrderQuantity.ToString("N0")</td>
                        <td class="text-end fw-bold">@Model[i].ShortageQuantity.ToString("N2")</td>
                        <td class="text-end fw-bold text-primary">@Model[i].SuggestedPurchaseQuantity.ToString("N2")</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    @if (Model.Any(m => m.SuggestedPurchaseQuantity > 0))
    {
        <div class="mt-3">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-cart-plus-fill me-2"></i>Tạo Đơn Mua hàng Nháp cho các mục đã chọn
            </button>
        </div>
    }
    else
    {
        <div class="alert alert-success">Không có nguyên vật liệu nào cần mua thêm.</div>
    }
</form>

@section Scripts {
    @* SỬA LỖI JAVASCRIPT: Thêm dòng này để đảm bảo jQuery luôn được tải *@
    @* mình đã có jquery offline <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>*@
    <script>
        $(document).ready(function () {
            $("#selectAll").click(function () {
                $('tbody input[type="checkbox"]').prop('checked', $(this).prop('checked'));
            });
        });
    </script>
}
