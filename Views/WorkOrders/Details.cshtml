@model WebAppERP.Models.WorkOrder
@using WebAppERP.Models
@using WebAppERP.Helpers
@{
    ViewData["Title"] = "Chi tiết Lệnh sản xuất #" + Model.Id;
    var childWorkOrders = ViewBag.ChildWorkOrders as List<WorkOrder> ?? new List<WorkOrder>();
}

@* ================================================================ *@
@* PHẦN HEADER VÀ HIỂN THỊ THÔNG BÁO                                *@
@* ================================================================ *@
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h1 class="display-6 mb-0">Lệnh sản xuất #@Model.Id</h1>
        <span class="badge fs-6 @(Model.Type == WorkOrderType.Master ? "bg-primary" : "bg-secondary")">@Html.DisplayFor(model => model.Type)</span>
        @if (Model.ProductionStage != null)
        {
            <span class="badge fs-6 bg-info">@Model.ProductionStage.Name</span>
        }
    </div>
    <div>
        <a asp-action="Index" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Quay lại danh sách</a>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}

<div class="row">
    <div class="col-lg-8">

        @* ================================================================ *@
        @* LUÔN HIỂN THỊ BẢNG TIẾN ĐỘ CÔNG ĐOẠN                            *@
        @* ================================================================ *@
        <div class="card mb-4">
            <div class="card-header"><h4><i class="bi bi-clipboard-data"></i> Tiến độ Công đoạn Tổng thể</h4></div>
            <div class="card-body p-0">
                @if (Model.WorkOrderRoutings != null && Model.WorkOrderRoutings.Any())
                {
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Công đoạn</th>
                                <th>Trạng thái</th>
                                <th>Yêu cầu / Đã SX</th>
                                <th style="min-width: 150px;">Tiến độ</th>
                                <th>Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var routing in Model.WorkOrderRoutings.OrderBy(r => r.ProductionStage.Sequence))
                            {
                                var progress = routing.QuantityToProduce > 0 ? (int)((double)routing.QuantityProduced / routing.QuantityToProduce * 100) : 0;
                                <tr>
                                    <td>@routing.ProductionStage.Name</td>
                                    <td><span class="badge bg-info">@routing.Status</span></td>
                                    <td>
                                        <a asp-controller="ProductionLog" asp-action="Index" asp-route-routingId="@routing.Id" title="Xem lịch sử ghi nhận">
                                            <strong>@routing.QuantityToProduce</strong> / <span class="text-success">@routing.QuantityProduced</span>
                                        </a>
                                    </td>
                                    <td>
                                        <div class="progress">
                                            <div class="progress-bar" role="progressbar" style="width: @(progress)%;" aria-valuenow="@progress" aria-valuemin="0" aria-valuemax="100">@progress%</div>
                                        </div>
                                    </td>
                                    <td>
                                        @if (Model.Status == WorkOrderStatus.InProgress && routing.Status != RoutingStatus.Completed)
                                        {
                                            <a asp-controller="ProductionLog" asp-action="Log" asp-route-routingId="@routing.Id" class="btn btn-sm btn-primary">Ghi nhận</a>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="p-3">
                        <div class="alert alert-warning mb-0">Lệnh sản xuất này chưa được thiết lập công đoạn sản xuất. (Vui lòng kiểm tra lại BOM của sản phẩm).</div>
                    </div>
                }
            </div>
        </div>

        @* ================================================================ *@
        @* CHỈ HIỂN THỊ CÂY LSX CON NẾU ĐÂY LÀ LSX TỔNG                    *@
        @* ================================================================ *@
        @if (Model.Type == WorkOrderType.Master && childWorkOrders.Any())
        {
            <div class="card mb-4">
                <div class="card-header">
                    <h4><i class="bi bi-diagram-3-fill"></i> Cây Lệnh sản xuất con</h4>
                </div>
                <div class="card-body p-0">
                    <table class="table table-sm table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID Lệnh con</th>
                                <th>Mô tả</th>
                                <th>Sản phẩm / Công đoạn</th>
                                <th>Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var child in childWorkOrders)
                            {
                                <tr>
                                    <td><a asp-action="Details" asp-route-id="@child.Id"><strong>#@child.Id</strong></a></td>
                                    <td>@child.Description</td>
                                    <td>
                                        @if (child.Type == WorkOrderType.Stage)
                                        {<span class="badge bg-info">@child.ProductionStage?.Name</span> }
                                    else
                                    { @child.Product?.Name}
                                    </td>
                                    <td><span class="badge bg-success">@child.Status</span></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>

    @* ================================================================ *@
    @* PHẦN CÁC NÚT HÀNH ĐỘNG                                          *@
    @* ================================================================ *@
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-play-circle"></i> Hành động</h5>
            </div>
            <div class="card-body">
                @if (Model.Type == WorkOrderType.Master && Model.Status == WorkOrderStatus.New)
                {
                    <form asp-action="ReleaseWorkOrder" method="post" class="d-block mb-2">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-primary w-100">Ban hành Lệnh sản xuất</button>
                    </form>
                }

                @if (Model.Type != WorkOrderType.Master && Model.Status == WorkOrderStatus.New)
                {
                    <form asp-action="StartProduction" method="post" class="d-block mb-2">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-primary w-100">Bắt đầu Sản xuất</button>
                    </form>
                }

                @if (Model.Type != WorkOrderType.Master && Model.Status == WorkOrderStatus.InProgress && Model.WorkOrderRoutings.All(r => r.Status == RoutingStatus.Completed))
                {
                    <form asp-action="CompleteProduction" method="post" class="d-block mb-2">
                        <input type="hidden" name="id" value="@Model.Id" />
                        <button type="submit" class="btn btn-success w-100">Hoàn thành Sản xuất</button>
                    </form>
                }

                @if (Model.Status != WorkOrderStatus.Completed && Model.Status != WorkOrderStatus.Cancelled)
                {
                    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-secondary w-100 mb-2">Chỉnh sửa</a>
                    <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-outline-danger w-100">Hủy Lệnh sản xuất</a>
                }
                @if (Model.Status == WorkOrderStatus.InProgress)
                {
                    <a asp-controller="MaterialRequisitions" asp-action="Manage" asp-route-workOrderId="@Model.Id" class="btn btn-info w-100 mb-2">
                        <i class="bi bi-box-arrow-down me-2"></i>Phiếu Lĩnh NVL
                    </a>}
            </div>
        </div>
    </div>
</div>